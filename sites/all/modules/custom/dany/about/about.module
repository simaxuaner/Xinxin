<?php
/**
 * Created by IntelliJ IDEA.
 * User: Sadako
 * Date: 2016/4/15
 * Time: 17:40
 */

/**
 * Implements hook_menu().
 */

function about_menu() {
	$items ['about'] = array (
			'title' => '产业园基地',
			'page callback' => 'about_introduction_page_callback',
			'access callback' => TRUE,
			'type' => MENU_SUGGESTED_ITEM,
			'menu_name' => 'main-menu',
			'weight' => 45 
	);
	$items ['about/introduction'] = array (
			'title' => '企业介绍',
			'access callback' => TRUE,
			'type' => MENU_DEFAULT_LOCAL_TASK, 
			'weight' => 45 
	);
	$items ['about/park'] = array (
			'title' => '园区风貌',
			'page callback' => 'about_park_page_callback',
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK ,
			'weight' => 35 
	);
	;
	$items ['about/school'] = array (
			'title' => '农业学校',
			'page callback' => 'about_school_page_callback',
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK, 
			'weight' => 25 
	);
	$items ['about/investors'] = array (
			'title' => '园区招商',
			'page callback' => 'about_investors_page_callback',
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK, 
			'weight' => 15 
	);
	$items ['about/partners'] = array (
			'title' => '入驻企业',
			'page callback' => 'about_partners_page_callback',
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK, 
			'weight' => 5 
	);
	$items ['about/recruitment'] = array (
			'title' => '人才招聘',
			'page callback' => 'about_recruitment_page_callback',
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK, 
			'weight' => 0 
	);
	return $items;
}
function about_introduction_page_callback() {
	global $user;
	$class="企业介绍";
	$module_path = drupal_get_path ( 'module', 'about' );
	$query = db_select ( 'node', 'n' );
	$nids = $query->fields ( 'n', array (
			'nid' 
	) )->condition ( 'type', "article" )->condition ( 'n.title', "企业介绍" )->condition ( 'status', '1' )->range ( 0, 1 )->orderBy ( 'created', 'ASC' )->addTag ( 'node_access' )->execute ()->fetchCol ();
	$nodes = node_load_multiple ( $nids );
	$html = '';
	foreach ( $nodes as $node ) {
		$html .= $node->body [LANGUAGE_NONE] [0] ['value'];
	}
	$pagehtml = <<<EOS
<section class="w80">
        <div class="bar">
            <h1>企业介绍</h1>
        </div>
        <div style="text-align:center">
            <video controls preload>
                <source src="$module_path/videos/video0.webm" />
                <source src="$module_path/videos/video0.mov" />
            </video>
        </div>
        </br>
        $html
</section>
EOS;
	return theme ( "aboutpage_page", array (
			"pagemain" => $pagehtml,
			"sidebarleft"=>get_sidebar_menu_list($class), 
	) );
}
function about_park_page_callback() {
	global $user;
	$class="园区风貌";
	$module_path = drupal_get_path ( 'module', 'about' );
	$query = db_select ( 'node', 'n' );
	$nids = $query->fields ( 'n', array (
			'nid'
	) )->condition ( 'type', "article" )->condition ( 'n.title', "园区风貌" )->condition ( 'status', '1' )->range ( 0, 5 )->orderBy ( 'created', 'DEC' )->addTag ( 'node_access' )->execute ()->fetchCol ();
	$nodes = node_load_multiple ( $nids );
	$bodyhtml = '';
	foreach ( $nodes as $node ) {
		if(isset($node->field_image)){
			foreach ($node->field_image[LANGUAGE_NONE] as $img){
				$bodyhtml.='<img class="showcaseImg" src="'.file_create_url($img['uri']).'"/>';
			}
		}
		if(isset($node->body)){
			$bodyhtml .= $node->body [LANGUAGE_NONE] [0] ['value'];
		}
	}
	$parkhtml =<<<EOS
	<section class="w80">
			<div class="bar">
				<h1>园区风貌</h1>
			</div>
			$bodyhtml
		</section>
EOS;
	return theme ( "aboutpage_page", array (
			"pagemain" => $parkhtml ,
			"sidebarleft"=>get_sidebar_menu_list($class),
	) );
}
function about_school_page_callback() {
	global $user;
	$class="农业学校";
	$module_path = drupal_get_path ( 'module', 'about' );
	$query = db_select ( 'node', 'n' );
	$nids = $query->fields ( 'n', array (
			'nid'
	) )->condition ( 'type', "article" )->condition ( 'n.title', "农业学校" )->condition ( 'status', '1' )->range ( 0, 1 )->orderBy ( 'created', 'DEC' )->addTag ( 'node_access' )->execute ()->fetchCol ();
	$nodes = node_load_multiple ( $nids );
	$bodyhtml = '';
	foreach ( $nodes as $node ) {
		if(isset($node->field_image)){
			$bodyhtml.='<img class="w40 floatRight marginLeft marginBottom" src="'.file_create_url($node->field_image [LANGUAGE_NONE] [0] ['uri']).'"/>';
		}
		if(isset($node->body)){
			$bodyhtml .= $node->body [LANGUAGE_NONE] [0] ['value'];
		}
	}
	$schoolhtml = <<<EOS
 <section class="w80">
    <div class="bar">
        <h1>农业学校</h1>
    </div>
    <div>
	    $bodyhtml
    </div>
</section>
EOS;
	return theme ( "aboutpage_page", array (
			"pagemain" => $schoolhtml ,
			"sidebarleft"=>get_sidebar_menu_list($class),
	) );
}
function about_investors_page_callback() {
	global $user;
	$class="园区招商";
	$module_path = drupal_get_path ( 'module', 'about' );
	$query = db_select ( 'node', 'n' );
	$nids = $query->fields ( 'n', array (
			'nid'
	) )->condition ( 'type', "article" )->condition ( 'n.title', "园区招商" )->condition ( 'status', '1' )->range ( 0, 1 )->orderBy ( 'created', 'DEC' )->addTag ( 'node_access' )->execute ()->fetchCol ();
	$nodes = node_load_multiple ( $nids );
	$bodyhtml = '';
	foreach ( $nodes as $node ) {
		if(isset($node->field_image)){
			$bodyhtml.='<img class="w100" src="'.file_create_url($node->field_image [LANGUAGE_NONE] [0] ['uri']).'"/>';
		}
		if(isset($node->body)){
			$bodyhtml .= $node->body [LANGUAGE_NONE] [0] ['value'];
		}
	}
	$investorshtml =<<<EOS
	<section class="w80">
			<div class="bar">
				<h1>园区招商</h1>
			</div>
			$bodyhtml
		</section>
EOS;
	return theme ( "aboutpage_page", array (
			"pagemain" => $investorshtml ,
			"sidebarleft"=>get_sidebar_menu_list($class),
	) );
}
function about_partners_page_callback() {
	global $user;
	$class="入驻企业";
	$module_path = drupal_get_path ( 'module', 'about' );
	$query = db_select ( 'node', 'n' );
	$nids = $query->fields ( 'n', array (
			'nid'
	) )->condition ( 'type', "article" )->condition ( 'n.title', "入驻企业" )->condition ( 'status', '1' )->range ( 0, 1 )->orderBy ( 'created', 'DEC' )->addTag ( 'node_access' )->execute ()->fetchCol ();
	$nodes = node_load_multiple ( $nids );
	$bodyhtml = '';
	foreach ( $nodes as $node ) {
		if(isset($node->field_image)){
			$bodyhtml.='<img class="w100" src="'.file_create_url($node->field_image [LANGUAGE_NONE] [0] ['uri']).'"/>';
		}
		if(isset($node->body)){
			$bodyhtml .= $node->body [LANGUAGE_NONE] [0] ['value'];
		}
	}
	$partners =<<<EOS
	<section class="w80">
			<div class="bar">
				<h1>入驻企业</h1>
			</div>
			$bodyhtml		
	</section>
EOS;
	return theme ( "aboutpage_page", array (
			"pagemain" => $partners ,
			"sidebarleft"=>get_sidebar_menu_list($class),
	) );
}
function about_recruitment_page_callback(){
	global $user;
	$class="人才招聘";
	$module_path = drupal_get_path ( 'module', 'about' );
	$recruitmenttml=<<<EOS
	<div class="bar blue w80">
				<h1>人才招聘</h1>
                <div class="search floatRight">
					<a href="#"><img alt="search" src="$module_path/images/search_bar.png"></a><input name="search" type="text">
				</div>
                </div>
                <section class="w80">
                <table class="jobList w100 floatRight marginBottom marginTop">
				<thead>
                <tr>
					<td class="theme alignLeft w40">岗位名称</td>
					<td class="reply alignCenter w20">招聘人数</td>
					<td class="check alignCenter w20">发布时间</td>
					<td class="state alignRight w20">详情</td>
				</tr>
                </thead>
                <tbody>
				<tr>
				    <td class="theme alignLeft w40">商务运营专员</td>
					<td class="reply alignCenter w20">1</td>
					<td class="check alignCenter w20">2016.5.4</td>
					<td class="state alignRight w20"><a href="#" data-reveal-id="myModal01" data-animation="fade">查看详情</a></td>	
				</tr>
				<tr class="lighter">
					<td class="theme alignLeft w40">社会化媒体营销经理</td>
					<td class="reply alignCenter w20">2</td>
					<td class="check alignCenter w20">2016.5.4</td>
					<td class="state alignRight w20"><a href="#" data-reveal-id="myModal02" data-animation="fade">查看详情</a></td>	
				</tr>
				<tr>
				    <td class="theme alignLeft w40">内容（社区）运营专员</td>
					<td class="reply alignCenter w20">3</td>
					<td class="check alignCenter w20">2016.5.4</td>
					<td class="state alignRight w20"><a href="#" data-reveal-id="myModal03" data-animation="fade">查看详情</a></td>	
				</tr>
				</tbody>
			</table>
			</section>

       <div id="myModal01" class="reveal-modal">
			<h2>商务运营专员</h2><br>
            <h3>岗位描述：</h3>
			<p>根据业务规划负责拓展和维护商家合作关系</p>
            <p>负责商业化业务的承接及落地实施，并追踪效</p>
            <p>制定商务拓展业务合作流程及规范</p>
            <p>挖掘商户、优化运营的需求，深入挖掘并整合各方面优势资源</p>
            <h3>岗位要求：</h3>
			<p>性格外向，善于团队合作，有较强的沟通能力</p>
            <p>熟练使用Office办公软件及PPT等商务必备工具的使用</p>
            <p>工作认真细致、敬业负责、有很强的责任心和进取心</p>
            <h3>工作地点：</h3>
            <p>泉州</p>
            <br><p>简历发至邮箱：123@qq.com</p>
			<a class="close-reveal-modal">&#215;</a>
		</div>       
        <div id="myModal02" class="reveal-modal">
			<h2>社会化媒体营销经理</h2><br>
            <h3>岗位描述：</h3>
			<p>参与制定社会化媒体的营销方案及执行（包括但不限于微信、微博）</p>
            <p>把控品牌社会化媒体营销方向并进行传播</p>
            <p>配合内部产品及运营团队，规划站内外用户互动活动</p> 
            <p>营销效果的收集及分析</p>
            <h3>岗位要求：</h3>
			<p>本科及以上学历</p>
            <p>熟悉社会化媒体（微信、微博、百度、豆瓣等等）营销及运营</p>
            <p>思维活跃脑洞大，逻辑清晰善探索，有一定的文字功底</p>
            <p>对市场营销有热情，对品牌构建有敏感度</p>
            <h3>工作地点：</h3>
            <p>泉州</p>
            <br><p>简历发至邮箱：123@qq.com</p>
			<a class="close-reveal-modal">&#215;</a>
		</div>
         <div id="myModal03" class="reveal-modal">
			<h2>内容（社区）运营专员</h2><br>
            <h3>岗位描述：</h3>
			<p>负责各社区话题的发布、互动、维护</p>
            <p>负责带动、活跃社区氛围</p>
            <p>负责相关活动的策划和执行</p> 
            <p>营销效果的收集及分析</p>
            <h3>岗位要求：</h3>
			<p>长期混迹社区，熟悉移动互动型产品玩法</p>
            <p>对新鲜事物具有强烈敏感度，善于把握网络热点话题和热门词汇</p>
            <p>思维活跃脑洞大，逻辑清晰善探索，有一定的文字功底</p>
            <p>兴趣爱好广泛，或对某一兴趣领域有较深入的了解</p>
            <h3>工作地点：</h3>
            <p>泉州</p>
            <br><p>简历发至邮箱：123@qq.com</p>
			<a class="close-reveal-modal">&#215;</a>
		</div>
EOS;
	return theme ( "aboutpage_page", array (
			"pagemain" => $recruitmenttml ,
			"sidebarleft"=>get_sidebar_menu_list($class),
	) );
}
/**
 * Implements hook_theme()
 */
function about_theme() {
	return array (
			'aboutpage_page' => array (
					'template' => 'aboutpage',
					'variables' => array (
					) 
			) 
	);
}

function second_menu_sort_weights($link1, $link2) {
	return $link1['link']['weight'] < $link2['link']['weight'] ? 1 : 0;
}

function get_sidebar_menu_list($class){
	$sql = "SELECT m.load_functions, m.to_arg_functions, m.access_callback, m.access_arguments, m.page_callback, m.page_arguments, m.delivery_callback, m.title, m.title_callback, m.title_arguments, m.type, m.description, ml.*
    				FROM {menu_links} ml LEFT JOIN {menu_router} m ON m.path = ml.router_path
    				WHERE ml.menu_name = :menu
    				ORDER BY p1 ASC, p2 ASC, p3 ASC, p4 ASC, p5 ASC, p6 ASC, p7 ASC, p8 ASC, p9 ASC";
	$result = db_query ( $sql, array (
			':menu' => 'main-menu'
	), array (
			'fetch' => PDO::FETCH_ASSOC
	) );
	$links = array ();
	foreach ( $result as $item ) {
		$links [] = $item;
	}
	$tree = menu_tree_data ( $links );
	$menu_links = '<nav id="sideNav" class="w20"><ul>';
	foreach ( $tree as $menu_item ) {
		if (! empty ( $menu_item ['link'] ['title'] ) && $menu_item ['link'] ['title'] == '产业园基地') {
			$sublink = $menu_item ['below'];
			uasort($sublink, "second_menu_sort_weights");
			foreach ( $sublink as $sublinkitem ) {
				if($sublinkitem ['link'] ['title']==$class){
					$menu_links .='<li class="activeNavItem">';
				}
				else {
					$menu_links .='<li>';
				}
				$menu_links .= '<a href="' . url($sublinkitem ['link'] ['link_path']) . '">' . $sublinkitem ['link'] ['title'] . '</a></li>';
			}
		}
	}
	$menu_links .= '</ul></nav>';
	return $menu_links;
}
