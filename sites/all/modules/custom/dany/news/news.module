<?php
/**
 * Create by Visual Studio Code
 * Author : Dany
 * E-mail : ifeifei@stu.xmu.edu.cn
 * Data = 2016-04-15 18:26
 */
 
/**
 * Implements hook_menu()
 */
function news_menu(){
    $items['news'] = array(
        'title' => t('品牌论坛'),
        'page callback' => 'news_allnews_page_callback',
        'access callback' => TRUE,
        'weight'=>20,
        'type' => MENU_SUGGESTED_ITEM,
        'menu_name' => 'main-menu',
    );
    $items['news/allnews']=array(
        'title' => t('品牌论坛'),
        'type' => MENU_DEFAULT_LOCAL_TASK,
    );
    $items['news/news66']=array(
        'title' => t('6.6涂岭论坛'),
        'page callback' => 'news_news66_page_callback',
        'access callback' => TRUE,
        'type' => MENU_LOCAL_TASK,
        'weight' => 5,
    );
    $items['news/news1212']=array(
        'title' => t('12.12电商论坛'),
        'page callback' => 'news_news1212_page_callback',
        'access callback' => TRUE,
        'type' => MENU_LOCAL_TASK,
        'weight' => 5,
    );
    $items['news/newsxinhui']=array(
        'title' => t('海促会咨询'),
        'page callback' => 'news_newsxinhui_page_callback',
        'access callback' => TRUE,
        'type' => MENU_LOCAL_TASK,
        'weight' => 5,
    );
    return $items;
}

function news_allnews_page_callback()
{
    //$noteList=getNoteList('品牌论坛');
    return theme("allNews_page", array(
        //'noteList'  => $noteList,
    ));
}

function news_news66_page_callback()
{
    $noteList=getNoteList('66涂岭论坛');
    $magzineList=getMagzineList('66');
    return theme("news66_page", array(
        'noteList'  => $noteList,
        'magzineList' => $magzineList,
    ));
}

function news_news1212_page_callback()
{
    $noteList=getNoteList('1212电商论坛');
    $magzineList=getMagzineList('1212');
    return theme("news1212_page", array(
        'noteList'  => $noteList,
        'magzineList' => $magzineList,
    ));
}

function news_newsxinhui_page_callback()
{
    $noteList=getNoteList('海促会资讯');
    $magzineList=getMagzineList('xinxin');
    return theme("newsXinhui_page", array(
        'noteList'  => $noteList,
        'magzineList' => $magzineList,
    ));
}

/**
 * Implements hook_theme()
 */
function news_theme() {
    return array(
        'allNews_page'  => array(
            'variables'=> array('newsTitle'=>'品牌论坛',
                                'secondMenuNav'=>getNewsSecondMenuNav('/danyOrigin/'),
                                'info' => getNewsInfo(),
                            ),
            'template' => 'newsHead',
        ),
        'news66_page' => array(
            'variables'=> array('newsTitle'=>'6.6涂岭论坛',
                                'secondMenuNav'=>getNewsSecondMenuNav('/dany66/'),
                            ),
            'template' => 'allNews',
        ),
        'news1212_page' => array(
            'variables'=> array('newsTitle'=>'12.12电商论坛',
                                'secondMenuNav'=>getNewsSecondMenuNav('/dany1212/'),
                            ),
            'template' => 'allNews',
        ),
        'newsXinhui_page' => array(
            'variables'=> array('newsTitle'=>'海促会资讯',
                                'secondMenuNav'=>getNewsSecondMenuNav('/danyXinxin/'),     
                           ),
            'template' => 'allNews',
        ),
    );
}

function template_preprocess_allNews_page(&$variables) {
    $module_path = drupal_get_path('module','news');
    $variables['imageLinkPathHead']=$module_path;
}


//util function
function getNoteList($type)
{
    $noteList=array();
    $query = db_select('node', 'n')->extend('PagerDefault');
    $nids = $query
    ->fields('n', array('nid', 'created'))
    ->condition('type', 'front_news')
    ->condition('status', 1)
    ->orderBy('created', 'DESC')
    ->addTag('node_access')
    ->execute()
    ->fetchCol();

    if (!empty($nids)) {
        $nodes = node_load_multiple($nids);
        foreach ($nodes as $key => $node) {
            if($node->field_news_type[LANGUAGE_NONE][0]['value']==$type)
            {
                $imgid = $node->field_image[LANGUAGE_NONE][0]['fid'];
                $imgfile = file_load($imgid);
                $imageurl = file_create_url($imgfile->uri);
                $noteList[$key]=array(
                    'imgurl'      => $imageurl,
                    'date'        => changeDateform(date('m-d',$node->created)),
                    'title'       => $node->title,
                    'content'     => $node->body[LANGUAGE_NONE][0]['value'],
                );
            }
        }
    }
    return $noteList;
}

function getMagzineList($type)
{
    $magzineList=array();
    foreach(range(0,4) as $value)
    {
        $magzineList[$value]=array(
        'imgurl'      => 'images/magazine/magazine.jpg',
        'date' => 'Jackie Chan'.$value,
        'title'    => 'farmName1'.$value,
        'content'   => $value,
        );
    }
    return $magzineList;
}

function changeDateform($date)
{
    $m_d=explode("-",$date);
    switch($m_d[0])
    {
        case "01" :
        $month="Jan";
        break;   
        case "02" :
        $month="Feb";
        break;
        case "03" :
        $month="Mar";
        break;  
        case "04" :
        $month="Apr";
        break;
        case "05" :
        $month="May";
        break;  
        case "06" :
        $month="Jun";
        break;
        case "07" :
        $month="Jul";
        break;  
        case "08" :
        $month="Aug";
        break;
        case "09" :
        $month="Sep";
        break;  
        case "10" :
        $month="Oct";
        break;
        case "11" :
        $month="Nov";
        break;  
        case "12" :
        $month="Dec";
        break;
    }
    $day=$m_d[1];
    return $day." ". $month;
}

function getNewsSecondMenuNav($type)
{
    $nav='<nav id="sideNav" class="w20">
			<ul>
				<li class="danyOrigin"> <a href="?q=news/allnews">品牌论坛</a> </li>
				<li class="dany1212"> <a href="?q=news/news1212">12.12电商论坛</a> </li>
                <li class="dany66"> <a href="?q=news/news66">6.6涂岭论坛</a> </li>
				<li class="danyXinxin"> <a href="?q=news/newsxinhui">海促会资讯</a> </li>
				
			</ul>
		</nav>';
    $html=preg_replace($type,"activeNavItem",$nav);
    return $html;
}

function getNewsInfo()
{
    $info=array();
    $nid = variable_get('news66Info', 80);
    $node = node_load($nid);
    if ($node) {
        $info['news66'] = $node->body[LANGUAGE_NONE][0]['value'];
    }
    $nid = variable_get('news1212Info', 81);
    $node = node_load($nid);
    if ($node) {
        $info['news1212'] = $node->body[LANGUAGE_NONE][0]['value'];
    }
    $nid = variable_get('newsXinxinInfo', 82);
    $node = node_load($nid);
    if ($node) {
        $info['newsXinxin'] = $node->body[LANGUAGE_NONE][0]['value'];
    }
    return $info;
}
