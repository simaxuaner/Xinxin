<?php
/**
 * Created by PhpStorm.
 * User: yunjia
 * Date: 2016/4/16
 * Time: 16:18
 */

/**
 * Implements hook_node_info()
 * Create the farm node.
 */
function farm_node_info(){
    return array(
        'farm'=>array(
            'name' => t('farm'),
            'module' => 'farm',
            'base' => 'node_content',
            'description' => 'the farm node type for the company',
            'has_title' => TRUE,
            'has_body' => TRUE
        )
    );
}


/**
 * Implements hook_menu().
 */
function farm_menu()
{
    $items['admin/farm'] = array(
        'title' => t('农场管理'),
        'description' => '对站点中的农场进行管理,进行增加、编辑、删除等操作',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('farm_admin_content'),
        'access arguments' => array('access content overview'),
        'file' => 'farm_admin.pages.inc',
    );

    $items['admin/farm/add'] = array(
        'title' => '添加农场',
        'title callback' => 'check_plain',
        'page callback' => 'farm_add',
        'access callback' => 'node_access',
        'access arguments' => array('create', 'farm'),
        'type' => MENU_LOCAL_ACTION,
        'file' => 'farm_admin.pages.inc',
    );

    $items['admin/farm/%node'] = array(
        'title' => t('farm product'),
        'page callback' => 'farm_product_page',
        'page arguments' => array(2),
        'access arguments' => array('access content'),
        'file' => 'farm_product_admin.pages.inc',
    );

    $items['admin/farm/%/add'] = array(
        'title' => '添加产品',
        'title callback' => 'check_plain',
        'page callback' => 'farm_product_add',
        'page arguments' => array(2),
        'access callback' => 'node_access',
        'access arguments' => array('create', 'product'),
        'type' => MENU_LOCAL_ACTION,
        'file' => 'farm_product_admin.pages.inc',
    );

    //farm-front
    $items['farmshow'] = array(
        'title' => t('农业展馆'),
        'page callback' => 'farmshow_leisurefarm_page_callback',
        'access callback' => TRUE,
        'type' => MENU_SUGGESTED_ITEM,
        'menu_name'=>'main-menu',
        'weight'=>-1,
    );
    $items['farmshow/farm'] = array(
        'title' => t('休闲农庄'),
        'access callback' => TRUE,
        'type' => MENU_DEFAULT_LOCAL_TASK,
    );

    return $items;
}

/**
 * @return 休闲农庄页面
 */
function farmshow_leisurefarm_page_callback(){
    return theme('farm_page',array());
}

/**
 * @return array
 */
function farm_theme(){
    return array(
        'farm_page'=>array(
            'variables'=> array('title'=>'农庄'),
            'template' => 'farm',
        ),
        'product_page'=>array(
            'variables'=> array('title'=>'农产品'),
            'template' => 'farm',
        ),
    );
}

function template_preprocess_farm_page(&$variables){
    $variables['farm_page']='farmshow/farm';
    $variables['product_page']='farmshow/product';

    $build = "";
    $query = db_select('node', 'n')->extend('PagerDefault');
    $nids = $query
        ->fields('n', array('nid', 'created'))
        ->condition('type', 'farm')
        ->condition('status', 1)
        ->orderBy('created', 'DESC')
        ->limit(variable_get('default_nodes_main', 10))
        ->addTag('node_access')
        ->execute()
        ->fetchCol();

    if (!empty($nids)) {
        $nodes = node_load_multiple($nids);
    }

    foreach($nodes as $key=>$value){
        //查找出农场图片
        $farm_image_uri = $value->field_farm_image['und'][0]['uri'];
        $farm_image_locate = explode('//', $farm_image_uri);
        $farm_image_filepath = $GLOBALS['base_url'].'/sites/default/files/' . $farm_image_locate[1];

        //查询出此农场中的产品
        $query = db_select('field_data_field_product_farm', 'f')->extend('PagerDefault');
        $pids = $query
            ->fields('f', array('entity_id'))
            ->condition('f.field_product_farm_value', $value->nid)
            ->orderBy('entity_id', 'DESC')
            ->addTag('node_access')
            ->limit(10)
            ->execute()
            ->fetchCol();
        $products = node_load_multiple($pids);
        $product_images = array();
        foreach($products as $key => $product) {
            //获取产品图片
            $myfield_array = field_get_items('node', $product, 'field_product_photo');
            $image = isset($myfield_array[0]) ? $myfield_array[0] : '';
            $product_image_uri = $image['uri'];
            // assuming that the uri starts with "public://"
            $product_image_locate = explode('//', $product_image_uri);
            $product_image_filepath = $GLOBALS['base_url'] . '/sites/default/files/' . $product_image_locate[1];
            $product_images[$key] = $product_image_filepath;
        }

        $build .= "<div class='wideBlock'>";

        $build .= "<div class='blockTitle'><h2>".$value->title."</h2><br/>
                <h3>地址：".$value->field_farm_location['und'][0]['value']."</h3></div>";

        $build .="<img src='".$farm_image_filepath."' class='w40 floatLeft'/>";

        $build .="<div class='blockInformation w60 floatLeft'>
                <p class='alignRight'><a href='#' class=''>加入收藏</p></a>";
        $build .="<p>".$value->body['und'][0]['value']."</p>";
        $build .="<p class='alignRight'><a href='farm.php'>详细信息 ></a></p>" ;
        $build .="<div class='alignRight products'>";
        foreach($product_images as $value){
            $build .= "<img src=".$value.">";
        }
        $build .="</div></div></div>";
    }
    $variables['farm_term'] = $build;

    $build_search = "<div class='bar'><h1>农庄</h1>
                    <div class='search floatRight'><a href='#'><img src=".$GLOBALS['base_url']."/sites/all/themes/xinxin_front/images/icons/search_bar.png alt='search'></a><input type='text' name='search'></div>
                    <div class='button floatRight'><a href='farms1.php'>+</a></div>
                    </div>";
    $variables['search'] = $build_search;
}
